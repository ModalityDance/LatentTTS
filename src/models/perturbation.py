from typing import Callable
import re
import torch.nn as nn


class MCLinear(nn.Module):
    def __init__(
        self,
        linear: nn.Linear,
        p: float = 0.2,
    ):
        super().__init__()
        self.linear = linear
        self.dropout = nn.Dropout(p)

    def forward(self, x):
        y = self.linear(x)
        y = self.dropout(y)
        return y



def find_and_replace_target_modules(
    model,
    target_modules: str | list[str] | None = None,
    target_module_type: nn.Module | None = None,
    replace_fn: Callable = MCLinear,
    **kwargs,
):
    """
    Find the submodules of the model that match the target_modules, and replace them with the new modules generated by replace_fn.

    Args:
        model: nn.Module, the model to replace the target modules
        target_module_type: nn.Module, the type of the target modules to replace
        target_modules: str or list[str], the target modules to replace, support regular expression or endswith
        replace_fn: Callable, the function to replace the target modules
        **kwargs: the arguments to pass to the replace_fn constructor

    Returns:
        None, replace the model in place
    """
    # allow string (regular expression) or string list (endswith/regular expression)
    if target_modules is None:
        match_check = lambda name: True
    elif isinstance(target_modules, str):
        match_check = lambda name: re.fullmatch(target_modules, name)
    elif isinstance(target_modules, list):
        match_check = lambda name: any([name.endswith(n) or re.fullmatch(n, name) for n in target_modules])

    def recursive_replace(parent, prefix=""):
        for name, module in parent.named_children():
            full_name = f"{prefix}.{name}" if prefix else name
            # if the module is a nn.Linear and matches the target modules, replace it
            if match_check(name) and (target_module_type is None or isinstance(module, target_module_type)):
                new_module = replace_fn(module, **kwargs)
                setattr(parent, name, new_module)
            else:
                recursive_replace(module, full_name)

    recursive_replace(model)

